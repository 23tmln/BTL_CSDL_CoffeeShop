<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <title>Coffee Shop 36</title>

  <!-- Bootstrap 5 -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">

  <style>
    @media print {
      body * {
        visibility: hidden !important;
      }
      #billContent, #billContent * {
        visibility: visible !important;
      }
      #billContent {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        padding: 20px;
      }
    }
  </style>

</head>
<body class="bg-light">

<div class="container py-4">

  <h2 class="text-center mb-4 text-primary">Coffee Shop 36</h2>

  <div class="mb-4">
    <a href="nhanvien.html" class="btn btn-secondary">Quản lý nhân viên →</a>
  </div>

  <!-- ======================= FORM TẠO ĐƠN ======================= -->
  <div class="card p-4 mb-4">
    <h4 class="mb-3 text-primary">Tạo đơn hàng mới</h4>

    <label>Mã khách hàng:</label>
    <input id="maKH" class="form-control mb-3" placeholder="VD: KH01">

    <div class="row g-2 mb-3">
      <div class="col-md-6">
        <label>Chọn sản phẩm:</label>
        <select id="selectSP" class="form-control"></select>
      </div>

      <div class="col-md-3">
        <label>Số lượng:</label>
        <input id="soLuongSP" type="number" class="form-control" min="1" value="1">
      </div>

      <div class="col-md-3 d-flex align-items-end">
        <button onclick="addItem()" class="btn btn-success w-100">Thêm sản phẩm</button>
      </div>
    </div>

    <table class="table table-bordered" id="tableItems">
      <thead class="table-light">
      <tr>
        <th>Mã SP</th>
        <th>Tên SP</th>
        <th>Số lượng</th>
        <th>Xóa</th>
      </tr>
      </thead>
      <tbody></tbody>
    </table>

    <button onclick="createOrder()" class="btn btn-primary">Tạo đơn</button>
  </div>


  <!-- ======================= DANH SÁCH ĐƠN HÀNG ======================= -->
  <div class="card p-4">
    <h4 class="mb-3 text-secondary">Danh sách đơn hàng</h4>

    <div class="input-group mb-3">
      <input id="searchMaDH" class="form-control" placeholder="Nhập mã đơn hàng... VD: DH001">
      <button class="btn btn-primary" onclick="searchOrder()">Tìm kiếm</button>
    </div>

    <button onclick="loadDonHang()" class="btn btn-info mb-3">Tải lại</button>

    <table class="table table-bordered" id="tableOrders">
      <thead class="table-light">
      <tr>
        <th>Mã ĐH</th>
        <th>Ngày lập</th>
        <th>Khách hàng</th>
        <th>Nhân viên</th>
        <th>Tổng tiền</th>
        <th>Hành động</th>
      </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

</div>


<!-- ======================= POPUP SỬA ======================= -->
<div class="modal fade" id="editModal">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">

      <div class="modal-header bg-warning">
        <h5 class="modal-title">Sửa đơn hàng</h5>
        <button class="btn-close" data-bs-dismiss="modal"></button>
      </div>

      <div class="modal-body">
        <input id="editMaDH" type="hidden">

        <label>Mã khách hàng:</label>
        <input id="editMaKH" class="form-control mb-3">

        <h6>Sản phẩm trong đơn:</h6>
        <table class="table" id="editTable">
          <thead>
          <tr>
            <th>Mã SP</th>
            <th>Số lượng</th>
            <th>Xóa</th>
          </tr>
          </thead>
          <tbody></tbody>
        </table>

        <button class="btn btn-success" onclick="addEditItem()">+ Thêm SP</button>
      </div>

      <div class="modal-footer">
        <button class="btn btn-primary" onclick="saveEdit()">Lưu thay đổi</button>
      </div>

    </div>
  </div>
</div>


<!-- ======================= POPUP BILL ======================= -->
<div class="modal fade" id="billModal">
  <div class="modal-dialog">
    <div class="modal-content p-3" id="billContent">

      <h4 class="text-center">COFFEE SHOP 36</h4>
      <p class="text-center mb-0">------------------------------</p>

      <p><b>Mã đơn:</b> <span id="bill_ma"></span></p>
      <p><b>Khách hàng:</b> <span id="bill_kh"></span></p>
      <p><b>Ngày:</b> <span id="bill_ngay"></span></p>

      <h5 class="mt-3">Sản phẩm</h5>

      <table class="table table-bordered">
        <thead>
        <tr>
          <th>Tên SP</th>
          <th>SL</th>
          <th>Giá</th>
        </tr>
        </thead>
        <tbody id="bill_items"></tbody>
      </table>

      <h5 class="text-end">Tổng: <span id="bill_tong"></span> đ</h5>
      <button class="btn btn-primary w-100 mt-3" onclick="window.print()">In hóa đơn</button>

    </div>
  </div>
</div>


<!-- ======================= JS ======================= -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<script>

  let items = [];
  let editItems = [];

  // ================= LOAD SẢN PHẨM ================
  async function loadSanPham() {
    let res = await fetch("http://localhost:8080/api/sanpham");
    let data = await res.json();

    let select = document.getElementById("selectSP");
    select.innerHTML = "";

    data.forEach(sp => {
      let opt = document.createElement("option");
      opt.value = sp.maSP;
      opt.textContent = sp.maSP + " - " + sp.tenSP;
      select.appendChild(opt);
    });
  }


  // ================= ADD ITEM ================
  function addItem() {
    let maSP = document.getElementById("selectSP").value;
    let soLuong = parseInt(document.getElementById("soLuongSP").value);
    let tenSP = document.getElementById("selectSP").selectedOptions[0].text.split(" - ")[1];

    if (!maSP || soLuong <= 0) {
      alert("Chọn sản phẩm hợp lệ!");
      return;
    }

    items.push({ maSP, tenSP, soLuong });
    renderTable();
  }

  function renderTable() {
    let tbody = document.querySelector("#tableItems tbody");
    tbody.innerHTML = "";

    items.forEach((it, index) => {
      tbody.innerHTML += `
    <tr>
      <td>${it.maSP}</td>
      <td>${it.tenSP}</td>
      <td>${it.soLuong}</td>
      <td><button class="btn btn-danger btn-sm" onclick="removeItem(${index})">Xóa</button></td>
    </tr>`;
    });
  }

  function removeItem(i) {
    items.splice(i, 1);
    renderTable();
  }


  // ================= CREATE ORDER ================
  async function createOrder() {
    let maKH = document.getElementById("maKH").value;

    if (!maKH) return alert("Nhập mã khách hàng!");
    if (items.length === 0) return alert("Chưa chọn sản phẩm!");

    let body = {
      maKH,
      items: items.map(it => ({ maSP: it.maSP, soLuong: it.soLuong }))
    };

    let res = await fetch("http://localhost:8080/api/donhang", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(body)
    });

    if (res.ok) {
      alert("Tạo đơn thành công!");
      items = [];
      renderTable();
      loadDonHang();
    } else alert("Lỗi tạo đơn!");
  }


  // ================= SEARCH ORDER ================
  async function searchOrder() {
    let id = document.getElementById("searchMaDH").value.trim();

    if (id === "") return loadDonHang();

    let res = await fetch("http://localhost:8080/api/donhang/" + id);

    if (!res.ok) return alert("Không tìm thấy " + id);

    let dh = await res.json();

    let tbody = document.querySelector("#tableOrders tbody");
    tbody.innerHTML = `
  <tr>
    <td>${dh.maDonHang}</td>
    <td>${dh.ngayLap}</td>
    <td>${dh.tenKH}</td>
    <td>${dh.maNV}</td>
    <td>${dh.tongTien}</td>
    <td>
      <button class="btn btn-warning btn-sm" onclick="editOrder('${dh.maDonHang}')">Sửa</button>
      <button class="btn btn-danger btn-sm" onclick="deleteOrder('${dh.maDonHang}')">Xóa</button>
      <button class="btn btn-success btn-sm" onclick="printBill('${dh.maDonHang}')">In bill</button>
    </td>
  </tr>`;
  }


  // ================= LOAD ĐƠN HÀNG ================
  async function loadDonHang() {
    let res = await fetch("http://localhost:8080/api/donhang");
    let data = await res.json();

    let tbody = document.querySelector("#tableOrders tbody");
    tbody.innerHTML = "";

    data.forEach(dh => {
      tbody.innerHTML += `
    <tr>
      <td>${dh.maDonHang}</td>
      <td>${dh.ngayLap}</td>
      <td>${dh.tenKH}</td>
      <td>${dh.maNV}</td>
      <td>${dh.tongTien}</td>
      <td>
        <button class="btn btn-warning btn-sm" onclick="editOrder('${dh.maDonHang}')">Sửa</button>
        <button class="btn btn-danger btn-sm" onclick="deleteOrder('${dh.maDonHang}')">Xóa</button>
        <button class="btn btn-success btn-sm" onclick="printBill('${dh.maDonHang}')">In bill</button>
      </td>
    </tr>`;
    });
  }


  // ================= DELETE =================
  async function deleteOrder(id) {
    if (!confirm("Bạn chắc muốn xóa đơn này?")) return;

    let res = await fetch("http://localhost:8080/api/donhang/" + id, { method: "DELETE" });

    if (res.ok) {
      alert("Đã xóa!");
      loadDonHang();
    } else alert("Lỗi xóa!");
  }


  // ================= EDIT =================
  async function editOrder(id) {
    let res = await fetch("http://localhost:8080/api/donhang/" + id);
    if (!res.ok) return alert("Không tìm thấy đơn!");

    let dh = await res.json();

    document.getElementById("editMaDH").value = dh.maDonHang;
    document.getElementById("editMaKH").value = dh.maKH;

    editItems = dh.items.map(it => ({ maSP: it.maSP, soLuong: it.soLuong }));

    renderEditTable();
    new bootstrap.Modal(document.getElementById("editModal")).show();
  }

  function renderEditTable() {
    let tb = document.querySelector("#editTable tbody");
    tb.innerHTML = "";

    editItems.forEach((it, idx) => {
      tb.innerHTML += `
    <tr>
      <td>${it.maSP}</td>
      <td><input type="number" class="form-control" min="1" value="${it.soLuong}" onchange="updateEditQty(${idx}, this.value)"></td>
      <td><button class="btn btn-danger btn-sm" onclick="removeEditItem(${idx})">Xóa</button></td>
    </tr>`;
    });
  }

  function updateEditQty(i, sl) {
    editItems[i].soLuong = parseInt(sl);
  }

  function removeEditItem(i) {
    editItems.splice(i, 1);
    renderEditTable();
  }

  function addEditItem() {
    let ma = prompt("Nhập mã SP:");
    let sl = prompt("Số lượng:");
    if (!ma || !sl) return;
    editItems.push({ maSP: ma, soLuong: parseInt(sl) });
    renderEditTable();
  }

  async function saveEdit() {
    let id = document.getElementById("editMaDH").value;
    let maKH = document.getElementById("editMaKH").value;

    let body = {
      maKH,
      items: editItems.map(it => ({ maSP: it.maSP, soLuong: it.soLuong }))
    };

    let res = await fetch("http://localhost:8080/api/donhang/" + id, {
      method: "PUT",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(body)
    });

    if (res.ok) {
      alert("Đã cập nhật!");
      loadDonHang();
      bootstrap.Modal.getInstance(document.getElementById("editModal")).hide();
    } else alert("Lỗi khi sửa!");
  }


  // ================= PRINT BILL =================
  async function printBill(maDH) {
    let res = await fetch("http://localhost:8080/api/donhang/" + maDH);
    if (!res.ok) {
      alert("Không tìm thấy đơn!");
      return;
    }

    let dh = await res.json();

    document.getElementById("bill_ma").textContent = dh.maDonHang;
    document.getElementById("bill_kh").textContent = dh.tenKH;
    document.getElementById("bill_ngay").textContent = dh.ngayLap;
    document.getElementById("bill_tong").textContent = dh.tongTien.toLocaleString();

    let tb = document.getElementById("bill_items");
    tb.innerHTML = "";

    dh.items.forEach(it => {
      tb.innerHTML += `
      <tr>
        <td>${it.tenSP}</td>
        <td>${it.soLuong}</td>
        <td>${it.giaBanThucTe.toLocaleString()}</td>
      </tr>`;
    });

    new bootstrap.Modal(document.getElementById("billModal")).show();
  }


  // ===== INIT =====
  loadSanPham();
  loadDonHang();

</script>

</body>
</html>
