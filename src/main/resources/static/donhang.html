<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <title>Coffee Shop 36</title>

  <!-- Bootstrap -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css" rel="stylesheet">

  <style>
    body {
      background: #f8f4ef;
      font-family: "Segoe UI", sans-serif;
    }

    .header-coffee {
      background: #6f4e37;
      padding: 20px;
      border-radius: 12px;
      color: white;
      margin-bottom: 30px;
      box-shadow: 0 3px 10px rgba(0,0,0,0.15);
    }

    .card {
      border-radius: 12px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.05);
      border: none;
    }

    .table-hover tbody tr:hover {
      background: #fff8e1;
    }

    .btn-coffee {
      background: #6f4e37;
      color: white;
    }
    .btn-coffee:hover {
      background: #5b3f2d;
      color: white;
    }

    .modal-content {
      border-radius: 14px;
      padding: 10px;
    }

    @media print {
      body * { visibility: hidden; }
      #billContent, #billContent * { visibility: visible; }
      #billContent {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        padding: 20px;
      }
    }
  </style>
</head>

<body>
<div class="container py-4">

  <!-- ===== HEADER + LOGO ===== -->
  <div class="header-coffee d-flex align-items-center justify-content-center gap-4">

    <img src="/thanhhoacoffe.jpg"
         style="width: 120px; height: 120px; border-radius: 50%; background:white; padding:6px;">

    <div class="text-center">
      <h1 class="mb-0"> Coffee Shop 36</h1>
      <p class="mt-1 mb-0">Ở Đây Có Cà Phê Ngon Hơn NYC Của Bạn</p>
    </div>

  </div>


  <!-- LINK NHÂN VIÊN -->
  <div class="mb-4 text-end">
    <a href="nhanvien.html" class="btn btn-outline-dark">
      <i class="bi bi-people-fill"></i> Quản lý nhân viên
    </a>
  </div>

  <!-- ================= TẠO ĐƠN ================= -->
  <div class="card p-4 mb-4">
    <h4 class="mb-3 text-coffee"><i class="bi bi-receipt-cutoff"></i> Tạo đơn hàng mới</h4>

    <div class="row mb-3">
      <div class="col-md-4">
        <label class="fw-semibold">Mã khách hàng</label>
        <input id="maKH" class="form-control" placeholder="VD: KH01">
      </div>
    </div>

    <div class="row mb-3 g-3">
      <div class="col-md-5">
        <label class="fw-semibold">Chọn sản phẩm</label>
        <select id="selectSP" class="form-select"></select>
      </div>

      <div class="col-md-3">
        <label class="fw-semibold">Số lượng</label>
        <input id="soLuongSP" type="number" class="form-control" min="1" value="1">
      </div>

      <div class="col-md-4 d-flex align-items-end">
        <button class="btn btn-coffee w-100" onclick="addItem()">
          <i class="bi bi-plus-circle"></i> Thêm sản phẩm
        </button>
      </div>
    </div>

    <table class="table table-hover table-bordered mb-3" id="tableItems">
      <thead class="table-light">
      <tr>
        <th>Mã SP</th>
        <th>Tên SP</th>
        <th>Số lượng</th>
        <th></th>
      </tr>
      </thead>
      <tbody></tbody>
    </table>

    <button class="btn btn-success px-4" onclick="createOrder()">
      <i class="bi bi-check-circle"></i> Tạo đơn
    </button>
  </div>

  <!-- ================= DANH SÁCH ĐƠN ================= -->
  <div class="card p-4">

    <h4 class="mb-3"><i class="bi bi-card-list"></i> Danh sách đơn hàng</h4>

    <div class="input-group mb-3">
      <input id="searchMaDH" class="form-control" placeholder="Nhập mã đơn hàng...">
      <button class="btn btn-coffee" onclick="searchOrder()">
        <i class="bi bi-search"></i> Tìm
      </button>
    </div>

    <button class="btn btn-outline-dark mb-3" onclick="loadDonHang()">
      <i class="bi bi-arrow-clockwise"></i> Tải lại
    </button>

    <table class="table table-hover table-bordered" id="tableOrders">
      <thead class="table-light">
      <tr>
        <th>Mã ĐH</th>
        <th>Ngày lập</th>
        <th>Khách hàng</th>
        <th>Nhân viên</th>
        <th>Tổng tiền</th>
        <th class="text-center">Hành động</th>
      </tr>
      </thead>
      <tbody></tbody>
    </table>

  </div>
</div>


<!-- ========================================================= -->
<!-- ===================== MODAL SỬA ========================= -->
<!-- ========================================================= -->

<div class="modal fade" id="editModal">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">

      <div class="modal-header bg-warning text-dark">
        <h5 class="modal-title"><i class="bi bi-pencil-square"></i> Sửa đơn hàng</h5>
        <button class="btn-close" data-bs-dismiss="modal"></button>
      </div>

      <div class="modal-body">
        <input id="editMaDH" type="hidden">

        <label class="fw-semibold">Mã khách hàng:</label>
        <input id="editMaKH" class="form-control mb-3">

        <h6 class="fw-semibold mb-2">Sản phẩm trong đơn</h6>

        <table class="table table-bordered" id="editTable">
          <thead class="table-light">
          <tr>
            <th>Mã SP</th>
            <th>Số lượng</th>
            <th></th>
          </tr>
          </thead>
          <tbody></tbody>
        </table>

        <button class="btn btn-coffee" onclick="addEditItem()">
          <i class="bi bi-plus-circle"></i> Thêm SP
        </button>

      </div>

      <div class="modal-footer">
        <button class="btn btn-primary" onclick="saveEdit()">
          <i class="bi bi-save2"></i> Lưu thay đổi
        </button>
      </div>
    </div>
  </div>
</div>



<!-- ========================================================= -->
<!-- ===================== MODAL BILL ======================== -->
<!-- ========================================================= -->

<div class="modal fade" id="billModal">
  <div class="modal-dialog">
    <div class="modal-content p-4" id="billContent">

      <div class="text-center mb-2">
        <!-- Logo to -->
        <img src="/thanhhoacoffe.jpg"
             style="width:110px; height:110px; border-radius:50%; background:white; padding:8px; margin-bottom:8px;">
        <!-- Tên quán nhỏ lại -->
        <h3 class="mt-1" style="font-size:22px; font-weight:600;">COFFEE SHOP 36</h3>
      </div>

      <p class="text-center text-muted">____________________________</p>

      <p><b>Mã đơn:</b> <span id="bill_ma"></span></p>
      <p><b>Khách hàng:</b> <span id="bill_kh"></span></p>
      <p><b>Ngày:</b> <span id="bill_ngay"></span></p>

      <h5 class="mt-3 mb-2">Sản phẩm</h5>

      <table class="table table-bordered">
        <thead>
        <tr>
          <th>Tên SP</th>
          <th>SL</th>
          <th>Giá</th>
        </tr>
        </thead>
        <tbody id="bill_items"></tbody>
      </table>

      <!-- QR CODE THANH TOÁN -->
      <div class="text-center mt-4">
        <img src="/QR.jpg"
             style="width:180px; height:180px; border-radius:12px; margin-bottom:10px;">
        <p class="text-muted" style="font-size:13px;">Quét QR để thanh toán</p>
      </div>

      <h5 class="text-end mt-3">Tổng: <span id="bill_tong"></span> đ</h5>

      <button class="btn btn-coffee mt-3 w-100" onclick="window.print()">
        <i class="bi bi-printer"></i> In hóa đơn
      </button>

    </div>


  </div>
</div>


<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<!-- ========================================================= -->
<!-- ===================== JAVASCRIPT ========================= -->
<!-- ========================================================= -->

<script>

  let items = [];
  let editItems = [];

  // LOAD SẢN PHẨM
  async function loadSanPham() {
    let res = await fetch("http://localhost:8080/api/sanpham");
    let data = await res.json();

    let select = document.getElementById("selectSP");
    select.innerHTML = "";

    data.forEach(sp => {
      let opt = document.createElement("option");
      opt.value = sp.maSP;
      opt.textContent = sp.maSP + " - " + sp.tenSP;
      select.appendChild(opt);
    });
  }

  // THÊM SẢN PHẨM
  function addItem() {
    let maSP = document.getElementById("selectSP").value;
    let soLuong = parseInt(document.getElementById("soLuongSP").value);
    let tenSP = document.getElementById("selectSP").selectedOptions[0].text.split(" - ")[1];

    if (!maSP || soLuong <= 0) {
      alert("Chọn sản phẩm hợp lệ!");
      return;
    }

    items.push({ maSP, tenSP, soLuong });
    renderTable();
  }

  function renderTable() {
    let tbody = document.querySelector("#tableItems tbody");
    tbody.innerHTML = "";

    items.forEach((it, index) => {
      tbody.innerHTML += `
      <tr>
        <td>${it.maSP}</td>
        <td>${it.tenSP}</td>
        <td>${it.soLuong}</td>
        <td class="text-center">
          <button class="btn btn-danger btn-sm" onclick="removeItem(${index})">
            <i class="bi bi-trash"></i>
          </button>
        </td>
      </tr>`;
    });
  }

  function removeItem(i) {
    items.splice(i, 1);
    renderTable();
  }

  // TẠO ĐƠN
  async function createOrder() {
    let maKH = document.getElementById("maKH").value;

    if (!maKH) return alert("Nhập mã khách hàng!");
    if (items.length === 0) return alert("Chưa chọn sản phẩm!");

    let body = {
      maKH,
      items: items.map(it => ({ maSP: it.maSP, soLuong: it.soLuong }))
    };

    let res = await fetch("http://localhost:8080/api/donhang", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(body)
    });

    if (res.ok) {
      alert("Tạo đơn thành công!");
      items = [];
      renderTable();
      loadDonHang();
    } else alert("Lỗi tạo đơn!");
  }

  // LOAD DANH SÁCH ĐƠN
  async function loadDonHang() {
    let res = await fetch("http://localhost:8080/api/donhang");
    let data = await res.json();

    let tbody = document.querySelector("#tableOrders tbody");
    tbody.innerHTML = "";

    data.forEach(dh => {
      tbody.innerHTML += `
      <tr>
        <td>${dh.maDonHang}</td>
        <td>${dh.ngayLap}</td>
        <td>${dh.tenKH}</td>
        <td>${dh.maNV}</td>
        <td>${dh.tongTien.toLocaleString()}</td>
        <td class="text-center">
          <button class="btn btn-warning btn-sm" onclick="editOrder('${dh.maDonHang}')">
            <i class="bi bi-pencil-square"></i>
          </button>
          <button class="btn btn-danger btn-sm" onclick="deleteOrder('${dh.maDonHang}')">
            <i class="bi bi-trash"></i>
          </button>
          <button class="btn btn-success btn-sm" onclick="printBill('${dh.maDonHang}')">
            <i class="bi bi-printer"></i>
          </button>
        </td>
      </tr>`;
    });
  }

  // TÌM KIẾM
  async function searchOrder() {
    let id = document.getElementById("searchMaDH").value.trim();

    if (id === "") return loadDonHang();

    let res = await fetch("http://localhost:8080/api/donhang/" + id);

    if (!res.ok) return alert("Không tìm thấy " + id);

    let dh = await res.json();

    let tbody = document.querySelector("#tableOrders tbody");
    tbody.innerHTML = `
    <tr>
      <td>${dh.maDonHang}</td>
      <td>${dh.ngayLap}</td>
      <td>${dh.tenKH}</td>
      <td>${dh.maNV}</td>
      <td>${dh.tongTien.toLocaleString()}</td>
      <td class="text-center">
        <button class="btn btn-warning btn-sm" onclick="editOrder('${dh.maDonHang}')">
          <i class="bi bi-pencil-square"></i>
        </button>
        <button class="btn btn-danger btn-sm" onclick="deleteOrder('${dh.maDonHang}')">
          <i class="bi bi-trash"></i>
        </button>
        <button class="btn btn-success btn-sm" onclick="printBill('${dh.maDonHang}')">
          <i class="bi bi-printer"></i>
        </button>
      </td>
    </tr>`;
  }

  // XÓA
  async function deleteOrder(id) {
    if (!confirm("Bạn chắc muốn xóa đơn này?")) return;

    let res = await fetch("http://localhost:8080/api/donhang/" + id, { method: "DELETE" });

    if (res.ok) {
      alert("Đã xóa!");
      loadDonHang();
    } else alert("Lỗi xóa!");
  }

  // SỬA
  async function editOrder(id) {
    let res = await fetch("http://localhost:8080/api/donhang/" + id);
    if (!res.ok) return alert("Không tìm thấy đơn!");

    let dh = await res.json();

    document.getElementById("editMaDH").value = dh.maDonHang;
    document.getElementById("editMaKH").value = dh.maKH;

    editItems = dh.items.map(it => ({ maSP: it.maSP, soLuong: it.soLuong }));

    renderEditTable();
    new bootstrap.Modal(document.getElementById("editModal")).show();
  }

  function renderEditTable() {
    let tb = document.querySelector("#editTable tbody");
    tb.innerHTML = "";

    editItems.forEach((it, idx) => {
      tb.innerHTML += `
      <tr>
        <td>${it.maSP}</td>
        <td>
          <input type="number" class="form-control" min="1" value="${it.soLuong}" onchange="updateEditQty(${idx}, this.value)">
        </td>
        <td class="text-center">
          <button class="btn btn-danger btn-sm" onclick="removeEditItem(${idx})">
            <i class="bi bi-trash"></i>
          </button>
        </td>
      </tr>`;
    });
  }

  function updateEditQty(i, sl) {
    editItems[i].soLuong = parseInt(sl);
  }

  function removeEditItem(i) {
    editItems.splice(i, 1);
    renderEditTable();
  }

  function addEditItem() {
    let ma = prompt("Nhập mã SP:");
    let sl = prompt("Số lượng:");

    if (!ma || !sl) return;

    editItems.push({ maSP: ma, soLuong: parseInt(sl) });
    renderEditTable();
  }

  async function saveEdit() {
    let id = document.getElementById("editMaDH").value;
    let maKH = document.getElementById("editMaKH").value;

    let body = {
      maKH,
      items: editItems.map(it => ({ maSP: it.maSP, soLuong: it.soLuong }))
    };

    let res = await fetch("http://localhost:8080/api/donhang/" + id, {
      method: "PUT",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(body)
    });

    if (res.ok) {
      alert("Đã cập nhật!");
      loadDonHang();
      bootstrap.Modal.getInstance(document.getElementById("editModal")).hide();
    } else alert("Lỗi khi sửa!");
  }

  // IN BILL
  async function printBill(maDH) {
    let res = await fetch("http://localhost:8080/api/donhang/" + maDH);
    if (!res.ok) return alert("Không tìm thấy đơn!");

    let dh = await res.json();

    document.getElementById("bill_ma").textContent = dh.maDonHang;
    document.getElementById("bill_kh").textContent = dh.tenKH;
    document.getElementById("bill_ngay").textContent = dh.ngayLap;
    document.getElementById("bill_tong").textContent = dh.tongTien.toLocaleString();

    let tb = document.getElementById("bill_items");
    tb.innerHTML = "";

    dh.items.forEach(it => {
      tb.innerHTML += `
      <tr>
        <td>${it.tenSP}</td>
        <td>${it.soLuong}</td>
        <td>${it.giaBanThucTe.toLocaleString()}</td>
      </tr>`;
    });

    new bootstrap.Modal(document.getElementById("billModal")).show();
  }

  // KHỞI ĐỘNG
  loadSanPham();
  loadDonHang();

</script>

</body>
</html>
